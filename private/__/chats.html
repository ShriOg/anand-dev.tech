<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Imported Chats | She</title>
  <link rel="stylesheet" href="../css/personal.css">
  <style>
    .chat-viewer {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-secondary);
      border-radius: 1rem;
      overflow: hidden;
    }
    
    .chat-viewer-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-default);
    }
    
    .chat-viewer-back {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .chat-viewer-back:hover {
      background: var(--her-accent-subtle);
      color: var(--her-accent);
    }
    
    .chat-viewer-info {
      flex: 1;
    }
    
    .chat-viewer-name {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .chat-viewer-platform {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }
    
    .chat-messages-list {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .imported-msg {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    
    .imported-msg.them {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      align-self: flex-start;
      border-bottom-left-radius: 0.25rem;
    }
    
    .imported-msg.me {
      background: var(--her-accent);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 0.25rem;
    }
    
    .chat-list-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      padding: 1.5rem;
    }
    
    .no-chats {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }
    
    .no-chats-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- Auth Check -->
  <div id="authCheck" class="auth-checking">
    <div class="auth-checking-spinner"></div>
  </div>
  
  <!-- Ambient Background -->
  <div class="her-ambient-bg">
    <div class="her-ambient-orb her-ambient-orb-1"></div>
    <div class="her-ambient-orb her-ambient-orb-2"></div>
    <div class="her-ambient-orb her-ambient-orb-3"></div>
  </div>
  
  <!-- Main App -->
  <div id="chatsApp" class="her-app">
    <!-- Header -->
    <header class="her-header">
      <div class="her-header-left">
        <a href="../personal.html" class="her-back-btn">‚Üê Back</a>
        <h1 class="her-header-title">Imported Chats</h1>
      </div>
      <div class="her-header-right">
        <button class="her-btn her-btn-secondary" id="importBtn">
          <span>Import Chat</span>
        </button>
      </div>
    </header>
    
    <!-- Content -->
    <main class="her-main" style="padding: 0;">
      <!-- Chat List View -->
      <div id="chatListView">
        <div id="chatList" class="chat-list-container"></div>
        <div id="noChats" class="no-chats" style="display: none;">
          <div class="no-chats-icon">üí¨</div>
          <p>No imported chats yet</p>
          <p style="font-size: 0.8125rem; margin-top: 0.5rem; color: var(--text-tertiary);">
            Import WhatsApp or Instagram conversations
          </p>
          <button class="her-btn her-btn-primary" style="margin-top: 1.5rem;" onclick="ChatsApp.openImportModal()">
            Import First Chat
          </button>
        </div>
      </div>
      
      <!-- Chat Viewer -->
      <div id="chatViewerView" class="chat-viewer" style="display: none;">
        <div class="chat-viewer-header">
          <button class="chat-viewer-back" onclick="ChatsApp.closeViewer()">‚Üê</button>
          <div class="chat-viewer-info">
            <div class="chat-viewer-name" id="viewerName"></div>
            <div class="chat-viewer-platform" id="viewerPlatform"></div>
          </div>
          <button class="her-btn her-btn-secondary" onclick="ChatsApp.deleteChat()">Delete</button>
        </div>
        <div class="chat-messages-list" id="chatMessagesView"></div>
      </div>
    </main>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="her-toast-container"></div>
    
    <!-- Modal -->
    <div id="modalOverlay" class="her-modal-overlay">
      <div class="her-modal">
        <div class="her-modal-header">
          <h2 class="her-modal-title" id="modalTitle"></h2>
          <button class="her-modal-close" id="modalClose">√ó</button>
        </div>
        <div class="her-modal-body" id="modalBody"></div>
      </div>
    </div>
  </div>
  
  <script src="../js/database.js"></script>
  <script>
    const ChatsApp = {
      SESSION_KEY: 'ps_session_active',
      chats: [],
      currentChat: null,
      
      async init() {
        if (sessionStorage.getItem(this.SESSION_KEY) !== 'true') {
          window.location.href = '../index.html';
          return;
        }
        
        document.getElementById('authCheck').classList.add('hidden');
        document.getElementById('chatsApp').classList.add('visible');
        
        await Database.init();
        await this.loadChats();
        this.bindEvents();
      },
      
      bindEvents() {
        document.getElementById('importBtn')?.addEventListener('click', () => this.openImportModal());
        document.getElementById('modalOverlay')?.addEventListener('click', (e) => {
          if (e.target === document.getElementById('modalOverlay')) this.closeModal();
        });
        document.getElementById('modalClose')?.addEventListener('click', () => this.closeModal());
      },
      
      async loadChats() {
        try {
          this.chats = await Database.getAll('imported_chats') || [];
          this.renderChats();
        } catch (e) {
          this.chats = [];
          this.renderChats();
        }
      },
      
      renderChats() {
        const container = document.getElementById('chatList');
        const empty = document.getElementById('noChats');
        
        if (this.chats.length === 0) {
          container.innerHTML = '';
          empty.style.display = 'block';
          return;
        }
        
        empty.style.display = 'none';
        container.innerHTML = this.chats.map(chat => `
          <div class="her-imported-chat-card" onclick="ChatsApp.viewChat('${chat.id}')">
            <div class="her-imported-chat-header">
              <span class="her-imported-chat-icon">${chat.platform === 'whatsapp' ? 'üí¨' : 'üì∏'}</span>
              <span class="her-imported-chat-platform">${chat.platform}</span>
            </div>
            <h3 class="her-imported-chat-name">${this.escapeHtml(chat.name)}</h3>
            <p class="her-imported-chat-preview">${this.escapeHtml(chat.messages?.[0]?.content?.substring(0, 60) || 'No messages')}...</p>
            <div class="her-imported-chat-meta">
              <span>${chat.messages?.length || 0} messages</span>
              <span>${this.formatDate(chat.importedAt)}</span>
            </div>
          </div>
        `).join('');
      },
      
      async viewChat(id) {
        const chat = this.chats.find(c => c.id === id);
        if (!chat) return;
        
        this.currentChat = chat;
        
        document.getElementById('viewerName').textContent = chat.name;
        document.getElementById('viewerPlatform').textContent = `${chat.platform} ¬∑ ${chat.messages?.length || 0} messages`;
        
        document.getElementById('chatMessagesView').innerHTML = (chat.messages || []).map(msg => `
          <div class="imported-msg them">${this.escapeHtml(msg.content)}</div>
        `).join('');
        
        document.getElementById('chatListView').style.display = 'none';
        document.getElementById('chatViewerView').style.display = 'flex';
      },
      
      closeViewer() {
        document.getElementById('chatListView').style.display = 'block';
        document.getElementById('chatViewerView').style.display = 'none';
        this.currentChat = null;
      },
      
      async deleteChat() {
        if (!this.currentChat) return;
        
        if (!confirm('Delete this chat permanently?')) return;
        
        try {
          await Database.delete('imported_chats', this.currentChat.id);
          this.closeViewer();
          await this.loadChats();
          this.toast('Chat deleted', 'success');
        } catch (e) {
          this.toast('Failed to delete', 'error');
        }
      },
      
      openImportModal() {
        document.getElementById('modalTitle').textContent = 'Import Chat';
        document.getElementById('modalBody').innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
              <label style="display: block; font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Platform</label>
              <select id="importPlatform" style="width: 100%; padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: 0.625rem; color: var(--text-primary); font-size: 0.875rem;">
                <option value="whatsapp">WhatsApp</option>
                <option value="instagram">Instagram</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Contact Name</label>
              <input type="text" id="importName" placeholder="Their name" style="width: 100%; padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: 0.625rem; color: var(--text-primary); font-size: 0.875rem;">
            </div>
            <div>
              <label style="display: block; font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Paste Chat Export</label>
              <textarea id="importContent" rows="8" placeholder="Paste the exported chat text here..." style="width: 100%; padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: 0.625rem; color: var(--text-primary); font-family: inherit; font-size: 0.875rem; resize: vertical;"></textarea>
            </div>
            <button class="her-btn her-btn-primary" onclick="ChatsApp.importChat()">Import Chat</button>
          </div>
        `;
        this.openModal();
      },
      
      async importChat() {
        const platform = document.getElementById('importPlatform')?.value;
        const name = document.getElementById('importName')?.value?.trim();
        const content = document.getElementById('importContent')?.value?.trim();
        
        if (!name || !content) {
          this.toast('Please fill all fields', 'error');
          return;
        }
        
        const messages = content.split('\n').filter(l => l.trim()).map(line => ({
          content: line.trim(),
          timestamp: Date.now()
        }));
        
        try {
          await Database.add('imported_chats', {
            id: crypto.randomUUID(),
            platform,
            name,
            messages,
            importedAt: Date.now()
          });
          
          this.closeModal();
          await this.loadChats();
          this.toast(`Imported ${messages.length} messages`, 'success');
        } catch (e) {
          this.toast('Failed to import', 'error');
        }
      },
      
      openModal() {
        document.getElementById('modalOverlay')?.classList.add('visible');
      },
      
      closeModal() {
        document.getElementById('modalOverlay')?.classList.remove('visible');
      },
      
      toast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `her-toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('hiding');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      },
      
      escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      },
      
      formatDate(ts) {
        return ts ? new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
      }
    };
    
    document.addEventListener('DOMContentLoaded', () => ChatsApp.init());
  </script>
</body>
</html>
