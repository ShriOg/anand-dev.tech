<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0a0a0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="robots" content="noindex, nofollow">
  <title>Instagram DMs</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a24;
      --bg-hover: #22222e;
      --text-primary: #f5f5f7;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --border-default: rgba(255,255,255,0.06);
      --border-hover: rgba(255,255,255,0.12);
      --accent: #e1306c;
      --accent-muted: rgba(225,48,108,0.15);
      --accent-glow: rgba(225,48,108,0.3);
      --msg-right-bg: linear-gradient(135deg, #405de6, #5851db, #833ab4, #c13584, #e1306c);
      --msg-left-bg: #262626;
      --radius-sm: 0.5rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.25rem;
      --radius-full: 22px;
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }
    
    .auth-check {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .auth-check.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    
    .auth-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--border-default);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .chat-app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    
    .chat-app.visible {
      opacity: 1;
    }
    
    .chat-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10,10,15,0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-default);
      padding: 0.875rem 1rem;
    }
    
    .chat-header-inner {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    
    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .chat-back {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
    }
    
    .chat-back:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }
    
    .chat-back svg {
      width: 20px;
      height: 20px;
    }
    
    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--msg-right-bg);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chat-avatar svg {
      width: 20px;
      height: 20px;
      fill: white;
    }
    
    .chat-info h1 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .chat-info span {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    .chat-lock-btn {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 0.75rem;
      background: transparent;
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .chat-lock-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-hover);
      color: var(--text-primary);
    }
    
    .chat-lock-btn svg {
      width: 16px;
      height: 16px;
    }
    
    .chat-tabs {
      display: flex;
      gap: 0.25rem;
      padding: 0.75rem 1rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-default);
    }
    
    .chat-tabs-inner {
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      gap: 0.25rem;
    }
    
    .chat-tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.625rem 0.75rem;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-muted);
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    
    .chat-tab:hover {
      color: var(--text-secondary);
      background: var(--bg-tertiary);
    }
    
    .chat-tab.active {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }
    
    .chat-tab svg {
      width: 18px;
      height: 18px;
    }
    
    .chat-tab-count {
      font-size: 0.6875rem;
      padding: 0.125rem 0.375rem;
      background: var(--bg-hover);
      border-radius: 999px;
      color: var(--text-muted);
    }
    
    .chat-tab.active .chat-tab-count {
      background: var(--accent-muted);
      color: var(--accent);
    }
    
    .chat-content {
      flex: 1;
      overflow-y: auto;
      overscroll-behavior: contain;
    }
    
    .chat-content-inner {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    .tab-panel {
      display: none;
    }
    
    .tab-panel.active {
      display: block;
    }
    
    .messages-container {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .date-separator {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem 0;
    }
    
    .date-separator span {
      font-size: 0.6875rem;
      color: var(--text-muted);
      background: var(--bg-secondary);
      padding: 0.375rem 0.75rem;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .message-row {
      display: flex;
      margin-bottom: 2px;
    }
    
    .message-row.msg-left {
      justify-content: flex-start;
    }
    
    .message-row.msg-right {
      justify-content: flex-end;
    }
    
    .message-bubble {
      max-width: 75%;
      padding: 0.625rem 0.875rem;
      border-radius: var(--radius-full);
      font-size: 0.9375rem;
      line-height: 1.4;
      word-wrap: break-word;
      position: relative;
    }
    
    .msg-left .message-bubble {
      background: var(--msg-left-bg);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
    }
    
    .msg-right .message-bubble {
      background: var(--msg-right-bg);
      color: white;
      border-bottom-right-radius: 4px;
    }
    
    .message-row.grouped-top .message-bubble {
      border-radius: var(--radius-full);
    }
    
    .message-row.grouped-middle .message-bubble {
      border-radius: var(--radius-full);
    }
    
    .message-row.grouped-bottom .message-bubble {
      border-radius: var(--radius-full);
    }
    
    .msg-left.grouped-top .message-bubble,
    .msg-left.grouped-middle .message-bubble {
      border-bottom-left-radius: 4px;
    }
    
    .msg-left.grouped-bottom .message-bubble {
      border-top-left-radius: 4px;
      border-bottom-left-radius: var(--radius-full);
    }
    
    .msg-right.grouped-top .message-bubble,
    .msg-right.grouped-middle .message-bubble {
      border-bottom-right-radius: 4px;
    }
    
    .msg-right.grouped-bottom .message-bubble {
      border-top-right-radius: 4px;
      border-bottom-right-radius: var(--radius-full);
    }
    
    .message-time {
      font-size: 0.625rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
      padding: 0 0.25rem;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .message-row:hover .message-time {
      opacity: 1;
    }
    
    .msg-right .message-time {
      text-align: right;
      color: rgba(255,255,255,0.5);
    }
    
    .message-text {
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .message-media {
      max-width: 280px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      cursor: pointer;
    }
    
    .message-media img {
      width: 100%;
      height: auto;
      display: block;
      transition: transform 0.3s ease;
    }
    
    .message-media:hover img {
      transform: scale(1.02);
    }
    
    .message-media.video-media {
      position: relative;
    }
    
    .message-media .video-play {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 48px;
      height: 48px;
      background: rgba(0,0,0,0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
      transition: all 0.25s ease;
    }
    
    .message-media:hover .video-play {
      transform: translate(-50%, -50%) scale(1.1);
      background: rgba(0,0,0,0.75);
    }
    
    .message-media .video-play svg {
      width: 20px;
      height: 20px;
      fill: white;
      margin-left: 2px;
    }
    
    .message-attachment {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: rgba(0,0,0,0.2);
      border-radius: var(--radius-md);
      margin-top: 0.5rem;
    }
    
    .message-attachment a {
      color: inherit;
      text-decoration: none;
      font-size: 0.8125rem;
      word-break: break-all;
    }
    
    .message-attachment a:hover {
      text-decoration: underline;
    }
    
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.5rem;
    }
    
    @media (min-width: 640px) {
      .media-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 0.75rem;
      }
    }
    
    .media-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--bg-tertiary);
      cursor: pointer;
      transition: transform 0.3s var(--ease-out), box-shadow 0.3s ease;
    }
    
    .media-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    
    .media-item img,
    .media-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .media-item-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.5) 0%, transparent 40%);
      opacity: 0;
      transition: opacity 0.25s ease;
    }
    
    .media-item:hover .media-item-overlay {
      opacity: 1;
    }
    
    .media-item-video-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 44px;
      height: 44px;
      background: rgba(0,0,0,0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }
    
    .media-item-video-indicator svg {
      width: 18px;
      height: 18px;
      fill: white;
      margin-left: 2px;
    }
    
    .media-viewer {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0,0,0,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .media-viewer.active {
      opacity: 1;
      visibility: visible;
    }
    
    .media-viewer-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }
    
    .media-viewer-close:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .media-viewer-close svg {
      width: 24px;
      height: 24px;
    }
    
    .media-viewer-content {
      max-width: 95vw;
      max-height: 90vh;
    }
    
    .media-viewer-content img {
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
      border-radius: var(--radius-md);
    }
    
    .media-viewer-content video {
      max-width: 100%;
      max-height: 90vh;
      border-radius: var(--radius-md);
    }
    
    .media-viewer-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .media-viewer-nav:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .media-viewer-nav.prev {
      left: 1rem;
    }
    
    .media-viewer-nav.next {
      right: 1rem;
    }
    
    .media-viewer-nav svg {
      width: 24px;
      height: 24px;
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      text-align: center;
    }
    
    .empty-state svg {
      width: 48px;
      height: 48px;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }
    
    .empty-state h3 {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    
    .empty-state p {
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
    }
    
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--border-default);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @media (max-width: 640px) {
      .chat-header {
        padding: 0.75rem;
      }
      
      .chat-info h1 {
        font-size: 0.9375rem;
      }
      
      .chat-lock-btn span {
        display: none;
      }
      
      .message-bubble {
        max-width: 85%;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
      }
      
      .message-media {
        max-width: 220px;
      }
      
      .media-viewer-nav {
        display: none;
      }
    }
    
    .timestamp-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: transparent;
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .timestamp-toggle:hover {
      background: var(--bg-tertiary);
    }
    
    .timestamp-toggle.active {
      background: var(--accent-muted);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .show-timestamps .message-time {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="auth-check" id="authCheck">
    <div class="auth-spinner"></div>
  </div>
  
  <div class="chat-app" id="chatApp">
    <header class="chat-header">
      <div class="chat-header-inner">
        <div class="chat-header-left">
          <a href="../" class="chat-back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </a>
          <div class="chat-avatar">
            <svg viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
          </div>
          <div class="chat-info">
            <h1 id="chatName">Instagram DMs</h1>
            <span id="chatMeta">Loading...</span>
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button class="timestamp-toggle" id="timestampToggle" title="Toggle timestamps">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
          </button>
          <button class="chat-lock-btn" id="lockBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <span>Lock</span>
          </button>
        </div>
      </div>
    </header>
    
    <nav class="chat-tabs">
      <div class="chat-tabs-inner">
        <button class="chat-tab active" data-tab="messages">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          Messages
          <span class="chat-tab-count" id="msgCount">0</span>
        </button>
        <button class="chat-tab" data-tab="photos">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21,15 16,10 5,21"/>
          </svg>
          Photos
          <span class="chat-tab-count" id="photoCount">0</span>
        </button>
        <button class="chat-tab" data-tab="videos">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="23,7 16,12 23,17"/>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
          </svg>
          Videos
          <span class="chat-tab-count" id="videoCount">0</span>
        </button>
      </div>
    </nav>
    
    <main class="chat-content" id="chatContent">
      <div class="chat-content-inner">
        <div class="tab-panel active" id="messagesPanel">
          <div class="loading-state">
            <div class="loading-spinner"></div>
          </div>
        </div>
        
        <div class="tab-panel" id="photosPanel">
          <div class="media-grid" id="photosGrid"></div>
        </div>
        
        <div class="tab-panel" id="videosPanel">
          <div class="media-grid" id="videosGrid"></div>
        </div>
      </div>
    </main>
  </div>
  
  <div class="media-viewer" id="mediaViewer">
    <button class="media-viewer-close" id="viewerClose">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    <button class="media-viewer-nav prev" id="viewerPrev">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
    </button>
    <button class="media-viewer-nav next" id="viewerNext">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 18l6-6-6-6"/>
      </svg>
    </button>
    <div class="media-viewer-content" id="viewerContent"></div>
  </div>

  <script>
    const InstagramViewer = {
      messages: [],
      photos: [],
      videos: [],
      participants: [],
      senderMapping: {},
      currentMediaIndex: 0,
      currentMediaType: 'photos',
      showTimestamps: false,
      
      async init() {
        if (!this.checkAuth()) return;
        
        document.getElementById('authCheck').classList.add('hidden');
        document.getElementById('chatApp').classList.add('visible');
        
        this.setupEventListeners();
        await this.loadMedia();
        await this.loadMessages();
        this.render();
      },
      
      checkAuth() {
        const isAuth = sessionStorage.getItem('ps_authenticated') === 'true';
        if (!isAuth) {
          window.location.href = '../../';
          return false;
        }
        return true;
      },
      
      setupEventListeners() {
        document.querySelectorAll('.chat-tab').forEach(tab => {
          tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
        });
        
        document.getElementById('lockBtn').addEventListener('click', () => {
          sessionStorage.removeItem('ps_authenticated');
          window.location.href = '../../';
        });
        
        document.getElementById('timestampToggle').addEventListener('click', () => {
          this.showTimestamps = !this.showTimestamps;
          document.getElementById('timestampToggle').classList.toggle('active', this.showTimestamps);
          document.getElementById('chatContent').classList.toggle('show-timestamps', this.showTimestamps);
        });
        
        document.getElementById('viewerClose').addEventListener('click', () => this.closeViewer());
        document.getElementById('viewerPrev').addEventListener('click', () => this.navigateMedia(-1));
        document.getElementById('viewerNext').addEventListener('click', () => this.navigateMedia(1));
        
        document.getElementById('mediaViewer').addEventListener('click', (e) => {
          if (e.target.id === 'mediaViewer') this.closeViewer();
        });
        
        document.addEventListener('keydown', (e) => {
          if (document.getElementById('mediaViewer').classList.contains('active')) {
            if (e.key === 'Escape') this.closeViewer();
            if (e.key === 'ArrowLeft') this.navigateMedia(-1);
            if (e.key === 'ArrowRight') this.navigateMedia(1);
          }
        });
      },
      
      async loadMedia() {
        const photoFiles = await this.getDirectoryFiles('photos/');
        const videoFiles = await this.getDirectoryFiles('videos/');
        
        this.photos = photoFiles.filter(f => /\.(jpg|jpeg|png|gif|webp)$/i.test(f));
        this.videos = videoFiles.filter(f => /\.(mp4|mov|webm)$/i.test(f));
        
        document.getElementById('photoCount').textContent = this.photos.length;
        document.getElementById('videoCount').textContent = this.videos.length;
      },
      
      async getDirectoryFiles(path) {
        const knownPhotos = [
          "1074790264819657.png", "1094269736212163.png", "1095202312754550.jpg", "1096538625545778.jpg",
          "1097921755355726.jpg", "1098684808911324.jpg", "1102692751984721.jpg", "1106874998239469.jpg",
          "1108460360862295.jpg", "1110481934012884.jpg", "1111902664366522.png", "1114255754186134.jpg",
          "1117134403248708.jpg", "1121225706623126.png", "1121244179476420.jpg", "1121537626593000.jpg",
          "1125554362870785.jpg", "1129421688515935.jpg", "1129913451983353.jpg", "1131601518919478.jpg",
          "1134430988645079.jpg", "1134985574725337.jpg", "1136026875286855.jpg", "1145511054307108.jpg",
          "1147892560637641.jpg", "1163481712277550.jpg", "1168329585351696.jpg", "1170389791569851.jpg",
          "1171765378337276.jpg", "1172455238250238.jpg", "1183844933561912.jpg", "1188882749853727.jpg"
        ];
        
        const knownVideos = [
          "1034927948691434.mp4", "1131444802504068.mp4", "1133922751527525.mp4", "1138400171044887.mp4",
          "1206889091459686.mp4", "1346143443802910.mp4", "1536961254133335.mp4", "1672182573477439.mp4",
          "1712029662799442.mp4", "1719219082073562.mp4", "1831830157468073.mp4", "1972913663483135.mp4",
          "1983119962539281.mp4", "2005675660170915.mp4", "2188385221657872.mp4", "24460806570255374.mp4",
          "2504344056609283.mp4", "25114722094778179.mp4", "658783657290105.mp4", "790780683886701.mp4",
          "802989182682686.mp4", "837127148886477.mp4"
        ];
        
        if (path.includes('photo')) return knownPhotos;
        if (path.includes('video')) return knownVideos;
        return [];
      },
      
      async loadMessages() {
        try {
          const response = await fetch('message_1.html');
          const html = await response.text();
          this.parseMessages(html);
        } catch (e) {
          console.error('Failed to load messages:', e);
        }
      },
      
      parseMessages(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const messageBlocks = doc.querySelectorAll('div.pam._3-95._2ph-._a6-g.uiBoxWhite.noborder');
        
        const participantSet = new Set();
        const msgs = [];
        
        messageBlocks.forEach(block => {
          const senderEl = block.querySelector('h2._a6-h');
          const contentEl = block.querySelector('div._a6-p');
          const timeEl = block.querySelector('div._a6-o');
          
          if (!senderEl || !timeEl) return;
          
          const sender = senderEl.textContent.trim();
          const timestamp = timeEl.textContent.trim();
          
          participantSet.add(sender);
          
          let text = '';
          let media = null;
          let link = null;
          
          if (contentEl) {
            const innerDiv = contentEl.querySelector(':scope > div');
            if (innerDiv) {
              const textDiv = innerDiv.querySelector(':scope > div:nth-child(2)');
              if (textDiv) {
                text = this.extractTextWithBreaks(textDiv);
              }
              
              const videoEl = innerDiv.querySelector('video');
              const imgEl = innerDiv.querySelector('img');
              
              if (videoEl) {
                const src = videoEl.getAttribute('src') || '';
                const filename = src.split('/').pop();
                if (filename) {
                  media = { type: 'video', src: 'videos/' + filename };
                }
              } else if (imgEl) {
                const src = imgEl.getAttribute('src') || '';
                const filename = src.split('/').pop();
                if (filename && !src.includes('Instagram-Logo')) {
                  media = { type: 'image', src: 'photos/' + filename };
                }
              }
              
              const linkEl = innerDiv.querySelector('a[target="_blank"]');
              if (linkEl) {
                const href = linkEl.getAttribute('href') || '';
                if (href.includes('instagram.com')) {
                  link = href;
                }
              }
            }
          }
          
          msgs.push({
            sender,
            text,
            timestamp,
            media,
            link,
            parsedTime: this.parseTime(timestamp)
          });
        });
        
        this.participants = Array.from(participantSet);
        this.buildSenderMapping();
        this.messages = msgs.reverse();
        
        document.getElementById('msgCount').textContent = this.messages.length;
        document.getElementById('chatMeta').textContent = `${this.messages.length} messages`;
      },
      
      extractTextWithBreaks(el) {
        if (!el) return '';
        let result = '';
        el.childNodes.forEach(node => {
          if (node.nodeType === Node.TEXT_NODE) {
            result += node.textContent;
          } else if (node.nodeType === Node.ELEMENT_NODE) {
            if (node.tagName === 'BR') {
              result += '\n';
            } else {
              result += this.extractTextWithBreaks(node);
            }
          }
        });
        return result.trim();
      },
      
      parseTime(timeStr) {
        const match = timeStr.match(/(\w+)\s+(\d+),\s+(\d+)\s+(\d+):(\d+)\s*(am|pm)/i);
        if (!match) return new Date();
        
        const months = { Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5, Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11 };
        let [, month, day, year, hours, minutes, ampm] = match;
        hours = parseInt(hours);
        if (ampm.toLowerCase() === 'pm' && hours !== 12) hours += 12;
        if (ampm.toLowerCase() === 'am' && hours === 12) hours = 0;
        
        return new Date(parseInt(year), months[month] || 0, parseInt(day), hours, parseInt(minutes));
      },
      
      buildSenderMapping() {
        if (this.participants.length === 2) {
          const me = this.participants.find(p => p === 'AS') || this.participants[1];
          const other = this.participants.find(p => p !== me);
          this.senderMapping[me] = 'right';
          this.senderMapping[other] = 'left';
        } else if (this.participants.length === 1) {
          this.senderMapping[this.participants[0]] = 'right';
        }
      },
      
      switchTab(tab) {
        document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
        
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(`${tab}Panel`).classList.add('active');
      },
      
      render() {
        this.renderMessages();
        this.renderPhotos();
        this.renderVideos();
      },
      
      renderMessages() {
        const container = document.getElementById('messagesPanel');
        if (this.messages.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              <h3>No messages</h3>
              <p>No messages found in this chat</p>
            </div>
          `;
          return;
        }
        
        let html = '<div class="messages-container">';
        let lastDate = null;
        let lastSender = null;
        
        this.messages.forEach((msg, i) => {
          const msgDate = msg.parsedTime.toDateString();
          const nextMsg = this.messages[i + 1];
          const prevMsg = this.messages[i - 1];
          
          if (msgDate !== lastDate) {
            html += `<div class="date-separator"><span>${this.formatDate(msg.parsedTime)}</span></div>`;
            lastDate = msgDate;
            lastSender = null;
          }
          
          const side = this.senderMapping[msg.sender] || 'left';
          const isSameSenderAsPrev = prevMsg && prevMsg.sender === msg.sender && prevMsg.parsedTime.toDateString() === msgDate;
          const isSameSenderAsNext = nextMsg && nextMsg.sender === msg.sender && nextMsg.parsedTime.toDateString() === msgDate;
          
          let groupClass = '';
          if (isSameSenderAsPrev && isSameSenderAsNext) groupClass = 'grouped-middle';
          else if (isSameSenderAsPrev) groupClass = 'grouped-bottom';
          else if (isSameSenderAsNext) groupClass = 'grouped-top';
          
          html += `<div class="message-row msg-${side} ${groupClass}">`;
          html += `<div class="message-bubble">`;
          
          if (msg.media) {
            if (msg.media.type === 'image') {
              html += `<div class="message-media" onclick="InstagramViewer.openMediaFromMsg('${msg.media.src}', 'image')">
                <img src="${msg.media.src}" alt="Photo" loading="lazy">
              </div>`;
            } else {
              html += `<div class="message-media video-media" onclick="InstagramViewer.openMediaFromMsg('${msg.media.src}', 'video')">
                <video src="${msg.media.src}" preload="metadata"></video>
                <div class="video-play">
                  <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
                </div>
              </div>`;
            }
          }
          
          if (msg.text && !this.isSystemMessage(msg.text)) {
            const formattedText = this.escapeHtml(msg.text).replace(/\n/g, '<br>');
            html += `<div class="message-text">${formattedText}</div>`;
          }
          
          if (msg.link) {
            html += `<div class="message-attachment">
              <a href="${msg.link}" target="_blank" rel="noopener">View on Instagram</a>
            </div>`;
          }
          
          html += `</div>`;
          html += `<div class="message-time">${this.formatTime(msg.parsedTime)}</div>`;
          html += `</div>`;
          
          lastSender = msg.sender;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
        container.scrollTop = container.scrollHeight;
      },
      
      renderPhotos() {
        const grid = document.getElementById('photosGrid');
        if (this.photos.length === 0) {
          grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21,15 16,10 5,21"/>
              </svg>
              <h3>No photos</h3>
              <p>No photos found in this chat</p>
            </div>
          `;
          return;
        }
        
        grid.innerHTML = this.photos.map((photo, i) => `
          <div class="media-item" onclick="InstagramViewer.openViewer('photos', ${i})">
            <img src="photos/${photo}" alt="Photo" loading="lazy">
            <div class="media-item-overlay"></div>
          </div>
        `).join('');
      },
      
      renderVideos() {
        const grid = document.getElementById('videosGrid');
        if (this.videos.length === 0) {
          grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="23,7 16,12 23,17"/>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
              </svg>
              <h3>No videos</h3>
              <p>No videos found in this chat</p>
            </div>
          `;
          return;
        }
        
        grid.innerHTML = this.videos.map((video, i) => `
          <div class="media-item" onclick="InstagramViewer.openViewer('videos', ${i})">
            <video src="videos/${video}" preload="metadata"></video>
            <div class="media-item-video-indicator">
              <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
            </div>
            <div class="media-item-overlay"></div>
          </div>
        `).join('');
      },
      
      openViewer(type, index) {
        this.currentMediaType = type;
        this.currentMediaIndex = index;
        this.updateViewer();
        document.getElementById('mediaViewer').classList.add('active');
        document.body.style.overflow = 'hidden';
      },
      
      openMediaFromMsg(src, type) {
        const list = type === 'image' ? this.photos : this.videos;
        const filename = src.split('/').pop();
        const index = list.findIndex(f => f === filename);
        
        if (index !== -1) {
          this.openViewer(type === 'image' ? 'photos' : 'videos', index);
        } else {
          this.currentMediaType = type === 'image' ? 'photos' : 'videos';
          this.currentMediaIndex = 0;
          const content = document.getElementById('viewerContent');
          if (type === 'image') {
            content.innerHTML = `<img src="${src}" alt="Photo">`;
          } else {
            content.innerHTML = `<video src="${src}" controls autoplay></video>`;
          }
          document.getElementById('mediaViewer').classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      },
      
      closeViewer() {
        document.getElementById('mediaViewer').classList.remove('active');
        document.body.style.overflow = '';
        const video = document.querySelector('#viewerContent video');
        if (video) video.pause();
      },
      
      navigateMedia(dir) {
        const list = this.currentMediaType === 'photos' ? this.photos : this.videos;
        this.currentMediaIndex = (this.currentMediaIndex + dir + list.length) % list.length;
        this.updateViewer();
      },
      
      updateViewer() {
        const content = document.getElementById('viewerContent');
        const list = this.currentMediaType === 'photos' ? this.photos : this.videos;
        const file = list[this.currentMediaIndex];
        
        if (this.currentMediaType === 'photos') {
          content.innerHTML = `<img src="photos/${file}" alt="Photo">`;
        } else {
          content.innerHTML = `<video src="videos/${file}" controls autoplay></video>`;
        }
      },
      
      formatDate(date) {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (date.toDateString() === today.toDateString()) return 'Today';
        if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
        
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      },
      
      formatTime(date) {
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      },
      
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },
      
      isSystemMessage(text) {
        if (!text) return true;
        const systemPhrases = [
          'You sent an attachment.',
          'sent an attachment.',
          'Liked a message',
          'liked a message'
        ];
        return systemPhrases.some(phrase => text.includes(phrase));
      }
    };
    
    document.addEventListener('DOMContentLoaded', () => InstagramViewer.init());
  </script>
</body>
</html>
